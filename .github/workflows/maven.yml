name: Run Tests

on:
  push:
    branches: [ "main", "scenario/*", "eval/*", "feature/*" ]
  pull_request:
    branches: [ "main", "scenario/*", "eval/*", "feature/*" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      issues: write        # so we can create & edit comments
      contents: read

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. post placeholder comment (EARLY) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create placeholder issue comment
        id: create_comment
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const issuePat = /#(\d+)/g;
            let issueNum = null, m;
            
            // â€¢ PR context
            if (context.payload.pull_request) {
              const whole = `${context.payload.pull_request.title}\n${context.payload.pull_request.body}`;
              if ((m = issuePat.exec(whole)) !== null) issueNum = +m[1];
            }
            
            // â€¢ Push context
            if (!issueNum && context.payload.commits) {
              for (const c of context.payload.commits) {
                if ((m = issuePat.exec(c.message)) !== null) { issueNum = +m[1]; break; }
              }
            }
            
            if (!issueNum) { core.info('No #issue reference found.'); return; }
            
            const body = `â³ **[${process.env.GITHUB_WORKFLOW}](${process.env.RUN_URL})** has **started**â€¦`;
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: issueNum,
              body
            });
            core.setOutput('comment_id', comment.id.toString());

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Java / Maven setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: 24
          distribution: temurin
          cache: maven

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. compile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - run: mvn -B compile --file pom.xml

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. extract FAIL_TO_PASS / PASS_TO_PASS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Extract test names
        id: extract_tests
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const grab = (txt, re) => [...txt.matchAll(re)].flatMap(m => m[1].split(/[ ,]+/));
            const uniq = a => [...new Set(a.filter(Boolean))];
            
            let blocks = [];
            if (context.eventName === 'pull_request') {
              blocks = [`${context.payload.pull_request.title}\n${context.payload.pull_request.body}`];
            } else if (context.eventName === 'push') {
              blocks = context.payload.commits.map(c => c.message);
            }
            
            const fail = blocks.flatMap(b => grab(b, /FAIL_TO_PASS:\s*([^\n]+)/gi));
            const pass = blocks.flatMap(b => grab(b, /PASS_TO_PASS:\s*([^\n]+)/gi));
            const tests = uniq([...fail, ...pass]).join(',');
            core.setOutput('tests', tests);

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. run tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run selected tests
        if: ${{ steps.extract_tests.outputs.tests }}
        run: mvn -B -Dtest="${{ steps.extract_tests.outputs.tests }}" test

      - name: Run all tests
        if: ${{ steps.extract_tests.outputs.tests == '' }}
        run: mvn -B test --file pom.xml

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7. update the same comment (FINAL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Update issue comment with final status
        if: always()
        uses: actions/github-script@v7
        env:
          COMMENT_ID: ${{ steps.create_comment.outputs.comment_id }}
          RUN_URL:    ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          JOB_STATUS: ${{ job.status }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            if (!process.env.COMMENT_ID) {
              core.info('No comment to update.'); return;
            }
            const statusEmoji = {
              success: 'âœ…',
              failure: 'âŒ',
              cancelled: 'ğŸŸ¡'
            }[process.env.JOB_STATUS] || 'ğŸŸ¡';
            
            const body = `${statusEmoji} **[${process.env.GITHUB_WORKFLOW}](${process.env.RUN_URL})** finished with status **${process.env.JOB_STATUS.toUpperCase()}**.`;
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              comment_id: Number(process.env.COMMENT_ID),
              body
            });
